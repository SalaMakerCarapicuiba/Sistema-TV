{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Horário de Aulas</title>
  <link rel="stylesheet" href="{% static 'css/index.css' %}" />
  <link rel="stylesheet" href="{% static 'css/global.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript">
    let noticeIndex = 0;

    // Mapeamento das descrições para os ícones
    const weatherIconMap = {
      'céu limpo': 'sun-fill.svg',
      'algumas nuvens': 'cloud-fill.svg',
      'nublado': 'cloud-fill.svg',
      'chuva leve': 'cloud-rain-fill.svg',
      'chuva moderada': 'cloud-rain-fill.svg',
      'trovoada': 'cloud-lightning-fill.svg',
      'garoa': 'umbrella-simple-fill.svg',
    };

    function getWeatherIcon(description = '') {
      // Retorna o ícone correspondente ou o ícone padrão se não encontrar
      return `{% static 'src/icons/' %}${weatherIconMap[description.toLowerCase()] || 'sun-fill.svg'}`;
    }

    function updateWeatherDisplay(data) {
      $("#today-temp").html(`${data.temp_min}°/${data.temp_max}°`);
      $("#today-icon").attr("src", getWeatherIcon(data.description));

      if (data.temp_min_tomorrow && data.temp_max_tomorrow) {
        $("#tomorrow-temp").html(`${data.temp_min_tomorrow}°/${data.temp_max_tomorrow}°`);
        $("#tomorrow-icon").attr("src", getWeatherIcon(data.description_tomorrow));
      } else {
        $("#tomorrow-temp").html("Dados indisponíveis");
      }

      if (data.agora) {
        const horaMinutos = new Date(data.agora).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        $("#time").html(horaMinutos);
      } else {
        $("#time").html("Horário indisponível");
      }
    }

    function fetchWeatherData() {
      $.get("{% url 'home' %}", function (data) {
        if (data.error) {
          console.error(data.error);
        } else {
          updateWeatherDisplay(data);
        }
      }).fail(function (xhr, status, error) {
        console.error("Erro ao obter dados da API:", status, error);
      });
    }

    function updateNoticeDisplay(data) {
      if (data.notice_image) {
        $(".small-window img").attr("src", data.notice_image);
      } else {
        $(".small-window img").remove();
        $(".small-window").html("<p>Sem imagem disponível</p>");
      }

      $(".textbox h1").html(data.notice_title);
      $(".textbox h3").html(data.notice_category);
      $(".textbox p").html(data.notice_content);
      noticeIndex = (noticeIndex + 1) % data.total_notices;
    }

    function fetchNoticeData() {
      $.get("{% url 'home' %}", { notice_index: noticeIndex }, function (data) {
        if (data.error) {
          console.error(data.error);
        } else {
          updateNoticeDisplay(data);
        }
      }).fail(function () {
        console.error("Erro ao obter os dados das notícias.");
      });
    }

    function positionHourMarkers() {
      const startTime = new Date();
      startTime.setHours(13, 50, 0); // Início às 13:50
      const endTime = new Date();
      endTime.setHours(20, 20, 0); // Fim às 20:20
      const totalDuration = endTime - startTime;

      // Função auxiliar para calcular a posição em percentual de um horário
      function getMarkerPosition(hours, minutes) {
          const markerTime = new Date();
          markerTime.setHours(hours, minutes, 0);
          const elapsedTime = markerTime - startTime;
          return (elapsedTime / totalDuration) * 100;
      }

      // Posiciona cada marcador de horário na barra de acordo com seu horário relativo
      document.getElementById('hour1').style.left = getMarkerPosition(13, 50) + '%';
      document.getElementById('hour2').style.left = getMarkerPosition(14, 30) + '%';
      document.getElementById('hour3').style.left = getMarkerPosition(15, 0) + '%';
      document.getElementById('hour4').style.left = getMarkerPosition(16, 10) + '%';
      document.getElementById('hour5').style.left = getMarkerPosition(20, 20) + '%';
    }


    function updateTimelinePosition() {
      const startTime = new Date();
      startTime.setHours(13, 50, 0); // Início às 13:50
      const endTime = new Date();
      endTime.setHours(20, 20, 0); // Fim às 20:20
      const currentTime = new Date();

      if (currentTime >= endTime) {
        currentTime.setHours(13, 50, 0); // Reinicia para 13:50
      }

      const totalDuration = endTime - startTime;
      const elapsedTime = currentTime - startTime;
      const percentage = (elapsedTime / totalDuration) * 100;

      const timeline = document.getElementById('timeline');
      timeline.style.left = percentage + '%';
    }

    $(document).ready(function () {
      // Carregar e atualizar os dados do clima e das notícias
      fetchWeatherData();
      fetchNoticeData();

      // Atualizar o clima e as notícias a cada 30 segundos
      setInterval(fetchWeatherData, 30000);
      setInterval(fetchNoticeData, 30000);

      // Chamar a função para definir a posição inicial do timeline
      updateTimelinePosition();
      // Posicionar os marcadores de horário
      positionHourMarkers();
      setInterval(updateTimelinePosition, 60000);
    });
</script>

</head>

<body class="flex space-between" style="background-image: url({% static 'src/banners/background.png' %})">
  <div class="left-column">
    <div class="left-window">
      <!-- <video width="100%" height="100%" controls autoplay src="{% static 'animation/Carregamento.mp4' %}"></video> -->
      <div class="horario">
        <div class="horario-header flex">
          <img src="{% static "src/icons/desktop.svg" %}" alt="">
          <h2>Análise e Desenvolvimento de Sistemas (ADS)</h2>
        </div>

         <div class="horario-table flex">
            <div class="semesters flex">
              <h2>1° Semestre</h2>
              <h2>2° Semestre</h2>
              <h2>3° Semestre</h2>
              <h2>4° Semestre</h2>
              <h2>5° Semestre</h2>
              <h2>6° Semestre</h2>
            </div>

            <div class="hours">
              <div class="hour-line">
                <div id ="divisor-line"></div>
                <div id="timeline">

                </div>
                <div class="hour-list flex">
                  <p class="hour-marker" id="hour1">13:50</p>
                  <p class="hour-marker" id="hour2">14:30</p>
                  <p class="hour-marker" id="hour3">15:00</p>
                  <p class="hour-marker" id="hour4">16:10</p>
                  <p class="hour-marker" id="hour5">20:20</p>
                </div>
              </div>
              <div class="class-line">
                <div class="classes flex">

                  <div class="class-line">
                    <div class="class">
                      <p>Mario Marques - Sala 101</p>
                    </div>
                  </div>

                  <div class="class-line">
                    <div class="class">
                      <p>Mario Marques - Sala 101</p>
                    </div>
                  </div>

                  <div class="class-line">
                    <div class="class">
                      <hp3>Mario Marques - Sala 101</h3>
                    </div>
                  </div>

                  <div class="class-line">
                    <div class="class">
                      <p>Mario Marques - Sala 101</p>
                    </div>
                  </div>

                  <div class="class-line">
                    <div class="class">
                      <p>Mario Marques - Sala 101</p>
                    </div>
                  </div>

                  <div class="class-line">
                    <div class="class">
                      <p>Mario Marques - Sala 101</p>
                    </div>
                  </div>

                </div>
              </div>
            </div>

         </div>
      </div>
    </div>

    <div class="description flex column">
      <div class="textbox flex column">
            <h3>{{ notice.category }}</h3>
            <p>{{ notice.content }}</p>
      </div>

      <div class="left-footer footer flex center vcenter">
        <div class="footer-left-text flex center vcenter">{{ data }}</div>

        <div class="footer-left-text flex center vcenter">
          <p id="time">Carregando...</p>
        </div>

        <div class="footer-left-text flex center vcenter">
          <p>Hoje</p>
          <img id="today-icon" src="{% static 'src/icons/sun-fill.svg' %}" alt="" />
          <p id="today-temp">Carregando...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="divisor flex space-between">
    <div class="line"></div>
    <div class="line"></div>
    <div class="line"></div>
  </div>

  <div class="right-column flex column center">
    <div class="right-window flex center">
      <div class="background flex center vcenter">
        <div class="background-red"></div>
        <div class="background-org"></div>
        <div class="background-ylw"></div>
        <div class="small-window">
          <img src="{% if notices %}{{ notices.0.imagem.url }}{% endif %}"
            alt="{% if notices %}{{ notices.0.subject }}{% endif %}">
        </div>
      </div>
    </div>

    <div class="textbox flex column right">
      {% with notice_index=0 %}
      {% for notice in notices %}
      {% if forloop.counter0 == notice_index %}
      <h1>{{ notice.subject }}</h1>
      <p>{{ notice.content }}</p>
      {% endif %}
      {% endfor %}
      {% endwith %}
    </div>

    <img class="fatec-banner" src="{% static 'src/banners/FatecCarapicuiba_Marca_Branca_Cor_SombraLateral.png' %}"
      alt="" />

    <div class="footer flex center vcenter">
      <p>Amanhã</p>
      <img id="tomorrow-icon" src="{% static '' %}" alt="" />
      <p id="tomorrow-temp">Carregando...</p>
    </div>
  </div>
</body>

</html>
