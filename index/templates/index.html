{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horário de Aulas</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}" />
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      let noticeIndex = 0;  // Começa na primeira notícia
    
      function fetchWeatherData() {
        $.ajax({
          url: "{% url 'home' %}",
          method: "GET",
          success: function (data) {
            if (data.error) {
              console.error(data.error);
            } else {
              // Atualiza o clima
              $("#today-temp").html(`${data.temp_min}°/${data.temp_max}°`);
              if (data.temp_min_tomorrow && data.temp_max_tomorrow) {
                $("#tomorrow-temp").html(`${data.temp_min_tomorrow}°/${data.temp_max_tomorrow}°`);
              } else {
                $("#tomorrow-temp").html("Dados indisponíveis");
              }
              let horaMinutos = new Date(data.agora).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
              $("#time").html(horaMinutos);
            }
          },
          error: function () {
            console.error("Erro ao obter dados da API.");
          },
        });
      }
    
      function fetchNoticeData() {
        $.ajax({
          url: "{% url 'home' %}",
          method: "GET",
          data: {
            notice_index: noticeIndex,  // Envia o índice da notícia atual para o servidor
          },
          success: function (data) {
            if (data.error) {
              console.error(data.error);
            } else {
              // Atualiza a pequena janela com a nova notícia
              if (data.notice_image) {
                $(".small-window img").attr("src", data.notice_image);
              } else {
                $(".small-window img").remove();
                $(".small-window").html("<p>Sem imagem disponível</p>");
              }
    
              // Atualiza o título e o conteúdo da notícia
              $(".textbox h1").html(data.notice_title);
              $(".textbox p").html(data.notice_content);
    
              // Incrementa o índice da notícia para a próxima requisição
              noticeIndex = (noticeIndex + 1) % data.total_notices;  // Cicla entre todas as notícias
            }
          },
          error: function () {
            console.error("Erro ao obter os dados das notícias.");
          },
        });
      }
    
      $(document).ready(function () {
        fetchWeatherData();  // Carrega os dados do clima ao carregar a página
        setInterval(fetchWeatherData, 30000);  // Atualiza o clima a cada 30 segundos
    
        fetchNoticeData();  // Carrega a primeira notícia ao carregar a página
        setInterval(fetchNoticeData, 30000);  // Atualiza as notícias a cada 30 segundos
      });
    </script>
    
  </head>

  <body
    class="flex space-between"
    style="background-image: url({%static 'src/banners/background.png' %})"
  >
    <div class="left-column">
      <div class="left-window">
        <video
          width="100%"
          height="100%"
          controls
          autoplay
          src="{% static 'animation/Carregamento.mp4' %}"
        ></video>
      </div>

      <div class="description flex column">
        <div class="textbox flex column">
          <h3>Titulo auxiliar 18pt</h3>
          <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent
            semper iaculis vulputate. Cras vel enim aliquet, commodo velit eu,
            commodo diam. Integer placerat eget enim quis faucibus. Cras vel en
          </p>
        </div>

        <div class="left-footer footer flex center vcenter">
          <div class="footer-left-text flex center vcenter">{{ data }}</div>

          <div class="footer-left-text flex center vcenter">
            <p id="time">Carregando...</p>
          </div>

          <div class="footer-left-text flex center vcenter">
            <p>Hoje</p>
            <img src="{% static 'src/icons/sun-fill.svg' %}" alt="" />
            <p id="today-temp">Carregando...</p>
            <!-- Aqui vai ser atualizado via JS -->
          </div>
        </div>
      </div>
    </div>

    <div class="divisor flex space-between">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>

    <div class="right-column flex column center">
      <div class="right-window flex center">
        <div class="background flex center vcenter">
          <div class="background-red"></div>
          <div class="background-org"></div>
          <div class="background-ylw"></div>
          <div class="small-window">
            <img src="{% if notices %}{{ notices.0.imagem.url }}{% endif %}" alt="{% if notices %}{{ notices.0.subject }}{% endif %}">
          </div>
          <div class="textbox flex column">
            <h1>{% if notices %}{{ notices.0.subject }}{% endif %}</h1>
            <p>{% if notices %}{{ notices.0.content }}{% endif %}</p>
          </div>
        </div>
      </div>

      <div class="textbox flex column">
        {% with notice_index=2 %} 
          {% for notice in notices %} 
            {% if forloop.counter0 == notice_index %}
              <h1>{{ notice.subject }}</h1>
              <p>{{ notice.content }}</p>     
            {% endif %} 
          {% endfor %} 
        {% endwith %}
      </div>

      <img
        class="fatec-banner"
        src="{% static 'src/banners/FatecCarapicuiba_Marca_Branca_Cor_SombraLateral.png' %}"
        alt=""
      />

      <div class="footer flex center vcenter">
        <p>Amanhã</p>
        <img src="{% static 'src/icons/umbrella-simple-fill.svg' %}" alt="" />
        <p id="tomorrow-temp">Carregando...</p>
        <!-- Aqui também vai ser atualizado via JS -->
      </div>
    </div>
  </body>
</html>
