{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Horário de Aulas</title>
  <link rel="stylesheet" href="{% static 'css/index.css' %}" />
  <link rel="stylesheet" href="{% static 'css/global.css' %}" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript">
    let noticeIndex = 0;

    // Mapeamento das descrições para os ícones
    const weatherIconMap = {
      'céu limpo': 'sun-fill.svg',
      'algumas nuvens': 'cloud-fill.svg',
      'nublado': 'cloud-fill.svg',
      'chuva leve': 'cloud-rain-fill.svg',
      'chuva moderada': 'cloud-rain-fill.svg',
      'trovoada': 'cloud-lightning-fill.svg',
      'garoa': 'umbrella-simple-fill.svg',
    };

    function getWeatherIcon(description) {
      // Verifica se description é uma string válida
      if (typeof description !== "string" || description.trim() === "") {
        console.warn("Descrição inválida para o ícone do clima:", description);
        return `{% static 'src/icons/sun-fill.svg' %}`;  // Ícone padrão em caso de erro
      }

      const icon = weatherIconMap[description.toLowerCase()] || 'sun-fill.svg';
      return `{% static 'src/icons/' %}${icon}`;
    }


    function fetchWeatherData() {
      $.ajax({
        url: "{% url 'home' %}",
        method: "GET",
        success: function (data) {
          console.log('Dados recebidos:', data); // Verifique o retorno da API

          if (data.error) {
            console.error(data.error);
          } else {
            // Atualiza a temperatura e o ícone de hoje
            $("#today-temp").html(`${data.temp_min}°/${data.temp_max}°`);

            // Verifica se a descrição do clima de hoje está disponível
            if (data.description) {
              $("#today-icon").attr("src", getWeatherIcon(data.description));
            } else {
              console.warn('Descrição do clima de hoje ausente');
              $("#today-icon").attr("src", getWeatherIcon(''));
            }

            // Atualiza a temperatura e o ícone de amanhã, se disponíveis
            if (data.temp_min_tomorrow && data.temp_max_tomorrow) {
              $("#tomorrow-temp").html(`${data.temp_min_tomorrow}°/${data.temp_max_tomorrow}°`);

              // Verifica se a descrição do clima de amanhã está disponível
              if (data.description_tomorrow) {
                $("#tomorrow-icon").attr("src", getWeatherIcon(data.description_tomorrow));
              } else {
                console.warn('Descrição do clima de amanhã ausente');
                $("#tomorrow-icon").attr("src", getWeatherIcon(''));
              }
            } else {
              $("#tomorrow-temp").html("Dados indisponíveis");
              console.warn('Dados de amanhã não disponíveis ou incompletos:', data);
            }

            // Atualiza o horário
            if (data.agora) {
              let horaMinutos = new Date(data.agora).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
              $("#time").html(horaMinutos);
            } else {
              $("#time").html("Horário indisponível");
              console.warn('Dados de horário não disponíveis:', data);
            }
          }
        },
        error: function (xhr, status, error) {
          console.error("Erro ao obter dados da API:", status, error);
        },
      });
    }

    function fetchNoticeData() {
      $.ajax({
        url: "{% url 'home' %}",
        method: "GET",
        data: {
          notice_index: noticeIndex,
        },
        success: function (data) {
          if (data.error) {
            console.error(data.error);
          } else {
            // Atualiza a pequena janela com a nova notícia
            if (data.notice_image) {
              $(".small-window img").attr("src", data.notice_image);
            } else {
              $(".small-window img").remove();
              $(".small-window").html("<p>Sem imagem disponível</p>");
            }

            // Atualiza o título e o conteúdo da notícia
            $(".textbox h1").html(data.notice_title);
            $(".textbox p").html(data.notice_content);

            // Incrementa o índice da notícia para a próxima requisição
            noticeIndex = (noticeIndex + 1) % data.total_notices;
          }
        },
        error: function () {
          console.error("Erro ao obter os dados das notícias.");
        },
      });
    }

    $(document).ready(function () {
      fetchWeatherData();  // Carrega os dados do clima ao carregar a página
      setInterval(fetchWeatherData, 30000);  // Atualiza o clima fa cada 30 segundos

      fetchNoticeData();  // Carrega a primeira notícia ao carregar a página
      setInterval(fetchNoticeData, 30000);  // Atualiza as notícias a cada 30 segundos
    });
  </script>
</head>

<body class="flex space-between" style="background-image: url({% static 'src/banners/background.png' %})">
  <div class="left-column">
    <div class="left-window">
      <video width="100%" height="100%" controls autoplay src="{% static 'animation/Carregamento.mp4' %}"></video>
    </div>

    <div class="description flex column">
      <div class="textbox flex column">
        <h3>Titulo auxiliar 18pt</h3>
        <p>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent
          semper iaculis vulputate. Cras vel enim aliquet, commodo velit eu,
          commodo diam. Integer placerat eget enim quis faucibus. Cras vel en
        </p>
      </div>

      <div class="left-footer footer flex center vcenter">
        <div class="footer-left-text flex center vcenter">{{ data }}</div>

        <div class="footer-left-text flex center vcenter">
          <p id="time">Carregando...</p>
        </div>

        <div class="footer-left-text flex center vcenter">
          <p>Hoje</p>
          <img id="today-icon" src="{% static 'src/icons/sun-fill.svg' %}" alt="" />
          <p id="today-temp">Carregando...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="divisor flex space-between">
    <div class="line"></div>
    <div class="line"></div>
    <div class="line"></div>
  </div>

  <div class="right-column flex column center">
    <div class="right-window flex center">
      <div class="background flex center vcenter">
        <div class="background-red"></div>
        <div class="background-org"></div>
        <div class="background-ylw"></div>
        <div class="small-window">
          <img src="{% if notices %}{{ notices.0.imagem.url }}{% endif %}"
            alt="{% if notices %}{{ notices.0.subject }}{% endif %}">
        </div>
      </div>
    </div>

    <div class="textbox flex column right">
      {% with notice_index=2 %}
      {% for notice in notices %}
      {% if forloop.counter0 == notice_index %}
      <h1>{{ notice.subject }}</h1>
      <p>{{ notice.content }}</p>
      {% endif %}
      {% endfor %}
      {% endwith %}
    </div>

    <img class="fatec-banner" src="{% static 'src/banners/FatecCarapicuiba_Marca_Branca_Cor_SombraLateral.png' %}"
      alt="" />

    <div class="footer flex center vcenter">
      <p>Amanhã</p>
      <img id="tomorrow-icon" src="{% static 'src/icons/umbrella-simple-fill.svg' %}" alt="" />
      <p id="tomorrow-temp">Carregando...</p>
    </div>
  </div>
</body>

</html>